---
import { getModels } from '../lib/supabase';
import Header from './Header.astro';
import { formatScore, formatPrice, formatTPS, formatTTFT } from '../lib/format-utils';
import Card from './ui/Card.astro';

const models = await getModels();

const validModels = models.filter((model: any) => {
  const inputPrice = Number(model.price_1m_input_tokens);
  const outputPrice = Number(model.price_1m_output_tokens);
  return inputPrice > 0 && outputPrice > 0;
});

const totalModels = validModels.length;
const INITIAL_VISIBLE_MODELS = Math.min(20, totalModels);
const avgInputPrice =
  validModels.reduce((sum: number, m: any) => sum + Number(m.price_1m_input_tokens), 0) /
  (totalModels || 1);
const avgOutputPrice =
  validModels.reduce((sum: number, m: any) => sum + Number(m.price_1m_output_tokens), 0) /
  (totalModels || 1);

const benchmarkConfigs = [
  { key: 'mmlu_pro', label: 'MMLU Pro' },
  { key: 'gpqa', label: 'GPQA' },
  { key: 'hle', label: 'HLE' },
  { key: 'aime', label: 'AIME' },
  { key: 'scicode', label: 'SciCode' },
  { key: 'math_500', label: 'Math 500' },
  { key: 'livecodebench', label: 'LiveCodeBench' },
  { key: 'aa_math_index', label: 'AA Math Index' },
  { key: 'aa_coding_index', label: 'AA Coding Index' },
  { key: 'aa_intelligence_index', label: 'AA Intelligence Index' },
];

const topByBenchmark = Object.fromEntries(
  benchmarkConfigs.map(({ key }) => {
    const list = [...validModels]
      .filter((m: any) => m[key] && Number(m[key]) > 0)
      .sort((a: any, b: any) => Number(b[key]) - Number(a[key]))
      .slice(0, 5);
    return [key, list];
  }),
) as Record<string, any[]>;

const topMmluModel = [...validModels]
  .filter((m: any) => m.mmlu_pro && Number(m.mmlu_pro) > 0)
  .sort((a: any, b: any) => Number(b.mmlu_pro) - Number(a.mmlu_pro))[0] ?? null;

const cheapestBlendedModel = [...validModels]
  .filter((m: any) => Number(m.price_1m_blended_3_to_1) > 0)
  .sort(
    (a: any, b: any) =>
      Number(a.price_1m_blended_3_to_1) - Number(b.price_1m_blended_3_to_1),
  )[0] ?? null;
---

<div class="min-h-screen bg-base text-text">
  <Header currentPage="dashboard" />

  <main class="mx-auto flex max-w-6xl flex-col gap-10 px-4 pb-16 pt-8 md:gap-12 md:pt-10">
    <!-- Hero (simplified, no large card) -->
    <section aria-label="AI Stats overview" class="mt-2">
      <div class="mx-auto flex max-w-4xl flex-col gap-5 md:flex-row md:items-start md:justify-between">
        <div class="text-left">
          <div
            class="inline-flex items-center gap-2 rounded-full border border-highlight-med/60 bg-overlay/70 px-3 py-1 text-[0.65rem] font-medium uppercase tracking-wide text-subtle"
          >
            <span class="h-1.5 w-1.5 rounded-full bg-foam" />
            <span>Live AI model pricing & benchmarks</span>
          </div>
          <h1
            class="mt-3 bg-gradient-to-r from-foam via-iris to-rose bg-clip-text text-3xl font-extrabold tracking-tight text-transparent sm:text-4xl md:text-5xl"
          >
            AI Stats
          </h1>
          <p class="mt-2 max-w-xl text-sm text-subtle sm:text-base">
            {totalModels} LLM models tracked with pricing & performance benchmarks.
            <br />
            Data sourced from ArtificialAnalysis.com in near real-time.
          </p>

          <div
            class="mt-4 inline-flex items-center gap-2 text-xs font-semibold text-text md:hidden"
            aria-label="Artificial Analysis"
          >
            <img
              src="/icons/Icon + Artificial Analysis - Horizontal SVG.svg"
              alt="Artificial Analysis"
              class="h-6 w-auto opacity-90"
            />
          </div>
        </div>

        <div class="hidden flex-col items-end gap-2 text-[0.65rem] text-subtle md:flex">
          <span class="text-[0.6rem] font-semibold uppercase tracking-wide text-muted">Data partner</span>
          <div
            class="inline-flex items-center gap-2 text-xs font-semibold text-text"
            aria-label="Artificial Analysis"
          >
            <img
              src="/icons/Icon + Artificial Analysis - Horizontal SVG.svg"
              alt="Artificial Analysis"
              class="h-7 w-auto opacity-90"
            />
          </div>
        </div>
      </div>

      <!-- Top model strip -->
      <div class="mx-auto mt-4 grid max-w-4xl gap-3 text-xs sm:text-sm md:grid-cols-2">
        <Card class="flex items-center justify-between px-4 py-3">
          <div class="text-subtle">Top MMLU model</div>
          <div class="text-right">
            <div class="text-sm font-semibold text-text">
              {topMmluModel ? topMmluModel.name : '—'}
            </div>
            <div class="text-[0.7rem] text-subtle">
              {topMmluModel ? formatScore(topMmluModel.mmlu_pro) : ''}
            </div>
          </div>
        </Card>
        <Card class="flex items-center justify-between px-4 py-3">
          <div class="text-subtle">Cheapest blended price (3:1)</div>
          <div class="text-right">
            <div class="text-sm font-semibold text-text">
              {cheapestBlendedModel ? cheapestBlendedModel.name : '—'}
            </div>
            <div class="text-[0.7rem] text-subtle">
              {cheapestBlendedModel
                ? formatPrice(
                    Number(cheapestBlendedModel.price_1m_blended_3_to_1) || 0,
                    3,
                  )
                : ''}
            </div>
          </div>
        </Card>
      </div>
    </section>

    <!-- Summary stats -->
    <section aria-label="Summary stats" class="mx-auto grid w-full max-w-4xl gap-4 md:grid-cols-3">
      <Card class="bg-gradient-to-b from-surface to-overlay px-4 py-5 text-center shadow-md shadow-black/30">
        <div class="text-[0.7rem] uppercase tracking-wide text-subtle">Total models</div>
        <div class="mt-2 text-2xl font-semibold text-text">{totalModels}</div>
        <p class="mt-1 text-[0.7rem] text-muted">From ArtificialAnalysis.com</p>
      </Card>
      <Card class="bg-gradient-to-b from-surface to-overlay px-4 py-5 text-center shadow-md shadow-black/30">
        <div class="text-[0.7rem] uppercase tracking-wide text-subtle">Avg input price</div>
        <div class="mt-2 text-2xl font-semibold text-text">{formatPrice(avgInputPrice, 3)}</div>
        <p class="mt-1 text-[0.7rem] text-muted">per 1M input tokens</p>
      </Card>
      <Card class="bg-gradient-to-b from-surface to-overlay px-4 py-5 text-center shadow-md shadow-black/30">
        <div class="text-[0.7rem] uppercase tracking-wide text-subtle">Avg output price</div>
        <div class="mt-2 text-2xl font-semibold text-text">{formatPrice(avgOutputPrice, 3)}</div>
        <p class="mt-1 text-[0.7rem] text-muted">per 1M output tokens</p>
      </Card>
    </section>

    <!-- Leaderboard -->
    <section aria-label="Leaderboard" class="space-y-4">
      <Card class="overflow-hidden rounded-3xl bg-surface/95 shadow-xl shadow-black/40">
        <header
          class="flex flex-col gap-3 border-b border-highlight-low/80 px-4 py-4 md:flex-row md:items-center md:justify-between md:px-6"
        >
          <div>
            <h2 class="text-base font-semibold text-text md:text-lg">Leaderboard</h2>
            <p class="text-[0.7rem] text-subtle md:text-xs">
              Switch metrics to see different top-5 rankings.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <label for="leaderboard-metric" class="text-[0.7rem] font-medium text-subtle">
              Metric
            </label>
            <select
              id="leaderboard-metric"
              class="rounded-md border border-highlight-med bg-surface px-2 py-1 text-[0.7rem] text-text shadow-sm focus:outline-none focus:ring-2 focus:ring-foam"
            >
              {benchmarkConfigs.map(({ key, label }) => (
                <option value={key} selected={key === 'mmlu_pro'}>
                  {label}
                </option>
              ))}
            </select>
          </div>
        </header>

        <div class="space-y-3 px-4 pb-4 pt-1 md:px-6 md:pb-6">
          {benchmarkConfigs.map(({ key }) => {
            const list = topByBenchmark[key] ?? [];
            if (!list.length) return null;

            return (
              <div
                data-metric={key}
                class="overflow-hidden rounded-2xl border border-highlight-low bg-overlay/80 shadow-inner shadow-black/30"
                hidden={key !== 'mmlu_pro'}
              >
                <div
                  class="grid grid-cols-[3rem_2fr_1fr] gap-3 border-b border-highlight-low bg-overlay px-4 py-2 text-[0.7rem] font-semibold uppercase tracking-wide text-subtle"
                >
                  <div>#</div>
                  <div>Model</div>
                  <div class="text-right">
                    {benchmarkConfigs.find((b) => b.key === key)?.label}
                  </div>
                </div>
                <ul class="divide-y divide-highlight-low/80">
                  {list.map((model: any, index: number) => (
                    <li
                      class="grid grid-cols-[3rem_2fr_1fr] items-center gap-3 px-4 py-3 transition-colors hover:bg-highlight-low/80"
                    >
                      <div
                        class="flex h-7 w-7 items-center justify-center rounded-full bg-highlight-med/80 text-xs font-semibold text-subtle"
                      >
                        {index + 1}
                      </div>
                      <div>
                        <div class="truncate text-sm font-medium text-text" title={model.name}>
                          {model.name}
                        </div>
                        <div class="mt-0.5 text-[0.7rem] text-subtle">
                          {model.company_name ?? 'Unknown provider'}
                        </div>
                      </div>
                      <div class="text-right text-sm font-semibold text-foam">
                        {formatScore(model[key])}
                      </div>
                    </li>
                  ))}
                </ul>
              </div>
            );
          })}
        </div>
      </Card>
    </section>

    <!-- All models -->
    <section aria-label="All models" class="space-y-4">
      <header class="flex flex-col gap-2 md:flex-row md:items-baseline md:justify-between">
        <div>
          <h2 class="text-lg font-semibold text-text">All models</h2>
          <p class="text-xs text-subtle">Search and scan every tracked model.</p>
        </div>
        <p class="text-xs text-subtle">
          Showing <span id="visible-model-count">{INITIAL_VISIBLE_MODELS}</span> of
          <span id="total-models-count">{totalModels}</span> models
        </p>
      </header>

      <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
        <div class="w-full md:max-w-xs">
          <label for="model-search" class="block text-xs font-medium text-subtle">
            Search models
          </label>
          <input
            id="model-search"
            type="text"
            placeholder="Search by name or company..."
            class="mt-1 w-full rounded-md border border-highlight-med bg-surface px-3 py-2 text-sm text-text shadow-sm placeholder:text-subtle focus:outline-none focus:ring-2 focus:ring-foam"
          />
        </div>

        <div class="w-full md:max-w-sm">
          <label for="model-sort" class="block text-xs font-medium text-subtle">
            Sort models
          </label>
          <div class="mt-1 flex flex-col gap-2 sm:flex-row sm:items-center">
            <select
              id="model-sort"
              class="w-full rounded-md border border-highlight-med bg-surface px-3 py-2 text-sm text-text shadow-sm focus:outline-none focus:ring-2 focus:ring-foam"
            >
              <option value="mmlu">MMLU Pro</option>
              <option value="gpqa">GPQA</option>
              <option value="hle">HLE</option>
              <option value="aime">AIME</option>
              <option value="inputPrice">Input price</option>
              <option value="outputPrice">Output price</option>
              <option value="tps">Tokens per second</option>
            </select>
            <select
              id="model-sort-direction"
              class="w-full rounded-md border border-highlight-med bg-surface px-3 py-2 text-sm text-text shadow-sm focus:outline-none focus:ring-2 focus:ring-foam sm:w-32"
            >
              <option value="desc">Top first</option>
              <option value="asc">Lowest first</option>
            </select>
          </div>
        </div>
      </div>

      <div class="grid gap-3 md:grid-cols-2" id="models-grid">
        {validModels.map((model: any) => (
          <article
            data-model-card
            data-name={(model.name ?? '').toLowerCase()}
            data-company={(model.company_name ?? '').toLowerCase()}
            data-mmlu={Number(model.mmlu_pro) || 0}
            data-gpqa={Number(model.gpqa) || 0}
            data-hle={Number(model.hle) || 0}
            data-aime={Number(model.aime) || 0}
            data-input-price={Number(model.price_1m_input_tokens) || 0}
            data-output-price={Number(model.price_1m_output_tokens) || 0}
            data-tps={Number(model.median_output_tokens_per_second) || 0}
            class="rounded-2xl border border-highlight-med bg-surface/95 px-4 py-4 text-sm shadow-md shadow-black/30 transition-transform hover:-translate-y-[1px] hover:border-foam/70 hover:shadow-lg hover:shadow-black/50"
          >
            <header class="flex items-baseline justify-between gap-2">
              <div>
                <h3 class="truncate text-sm font-semibold text-text" title={model.name}>
                  {model.name}
                </h3>
                <p class="mt-0.5 text-xs text-subtle">{model.company_name ?? 'Unknown provider'}</p>
              </div>
              <div class="text-right text-[0.65rem] text-subtle">
                <div>Input: {formatPrice(Number(model.price_1m_input_tokens) || 0, 3)}</div>
                <div>Output: {formatPrice(Number(model.price_1m_output_tokens) || 0, 3)}</div>
              </div>
            </header>

            <div class="mt-4 grid gap-3 text-[0.7rem] text-subtle md:grid-cols-2">
              <section class="rounded-lg border border-highlight-low/60 bg-overlay/50 px-3 py-2">
                <div class="text-[0.6rem] uppercase tracking-wide text-muted">Pricing</div>
                <dl class="mt-2 space-y-1 text-text">
                  <div class="flex items-center justify-between">
                    <dt>Input (1M)</dt>
                    <dd class="font-semibold">{formatPrice(Number(model.price_1m_input_tokens) || 0, 3)}</dd>
                  </div>
                  <div class="flex items-center justify-between">
                    <dt>Output (1M)</dt>
                    <dd class="font-semibold">{formatPrice(Number(model.price_1m_output_tokens) || 0, 3)}</dd>
                  </div>
                  <div class="flex items-center justify-between">
                    <dt>Blended (3:1)</dt>
                    <dd class="font-semibold">{formatPrice(Number(model.price_1m_blended_3_to_1) || 0, 3)}</dd>
                  </div>
                </dl>
              </section>

              <section class="rounded-lg border border-highlight-low/60 bg-overlay/50 px-3 py-2">
                <div class="text-[0.6rem] uppercase tracking-wide text-muted">Performance</div>
                <dl class="mt-2 space-y-1 text-text">
                  <div class="flex items-center justify-between">
                    <dt>Tokens / s</dt>
                    <dd class="font-semibold">{formatTPS(model.median_output_tokens_per_second)}</dd>
                  </div>
                  <div class="flex items-center justify-between">
                    <dt>TTFT (token)</dt>
                    <dd class="font-semibold">{formatTTFT(model.median_time_to_first_token_seconds)}</dd>
                  </div>
                  <div class="flex items-center justify-between">
                    <dt>TTFT (answer)</dt>
                    <dd class="font-semibold">{formatTTFT(model.median_time_to_first_answer_token)}</dd>
                  </div>
                </dl>
              </section>

              <section class="rounded-lg border border-highlight-low/60 bg-overlay/50 px-3 py-2 md:col-span-2">
                <div class="text-[0.6rem] uppercase tracking-wide text-muted">Benchmarks</div>
                <div class="mt-2 grid grid-cols-2 gap-2 sm:grid-cols-3">
                  {[
                    ['MMLU Pro', model.mmlu_pro],
                    ['GPQA', model.gpqa],
                    ['HLE', model.hle],
                    ['AIME', model.aime],
                    ['LiveCodeBench', model.livecodebench],
                    ['SciCode', model.scicode],
                    ['Math 500', model.math_500],
                  ].map(([label, value]) => (
                    <div class="rounded-md border border-highlight-low/60 px-2 py-2">
                      <div class="text-[0.6rem] uppercase tracking-wide text-muted">{label}</div>
                      <div class="text-sm font-semibold text-text">{formatScore(value)}</div>
                    </div>
                  ))}
                </div>
              </section>

              <section class="rounded-lg border border-highlight-low/60 bg-overlay/50 px-3 py-2 md:col-span-2">
                <div class="text-[0.6rem] uppercase tracking-wide text-muted">AA Indexes</div>
                <div class="mt-2 grid gap-2 sm:grid-cols-3">
                  <div class="rounded-md border border-highlight-low/60 px-2 py-2">
                    <div class="text-[0.6rem] uppercase tracking-wide text-muted">Intelligence</div>
                    <div class="text-sm font-semibold text-text">{formatScore(model.aa_intelligence_index)}</div>
                  </div>
                  <div class="rounded-md border border-highlight-low/60 px-2 py-2">
                    <div class="text-[0.6rem] uppercase tracking-wide text-muted">Coding</div>
                    <div class="text-sm font-semibold text-text">{formatScore(model.aa_coding_index)}</div>
                  </div>
                  <div class="rounded-md border border-highlight-low/60 px-2 py-2">
                    <div class="text-[0.6rem] uppercase tracking-wide text-muted">Math</div>
                    <div class="text-sm font-semibold text-text">{formatScore(model.aa_math_index)}</div>
                  </div>
                </div>
              </section>
            </div>
          </article>
        ))}
      </div>

      <div class="mt-4 flex justify-center">
        <button
          id="load-more-models"
          type="button"
          class="rounded-full border border-highlight-med bg-overlay/80 px-5 py-2 text-sm font-semibold text-text shadow-inner shadow-black/30 transition-colors hover:border-foam hover:text-foam"
        >
          Load more models
        </button>
      </div>
    </section>
  </main>
</div>

<script>
  // @ts-nocheck
  if (typeof window !== 'undefined') {
    const metricSelect = document.getElementById('leaderboard-metric');
    const metricContainers = document.querySelectorAll('[data-metric]');

    metricSelect?.addEventListener('change', (event) => {
      const value = event.target.value;
      metricContainers.forEach((el) => {
        if (!(el instanceof HTMLElement)) return;
        el.hidden = el.dataset.metric !== value;
      });
    });

    const PAGE_SIZE = 20;
    let currentVisible = PAGE_SIZE;
    let matchedTotal = 0;

    const searchInput = document.getElementById('model-search');
    const grid = document.getElementById('models-grid');
    const cards = Array.from(document.querySelectorAll('[data-model-card]'));
    const visibleCountEl = document.getElementById('visible-model-count');
    const loadMoreBtn = document.getElementById('load-more-models');
    const sortSelect = document.getElementById('model-sort');
    const sortDirectionSelect = document.getElementById('model-sort-direction');

    const updateVisibility = () => {
      let visible = 0;
      cards.forEach((card) => {
        const match = card.dataset.match === 'true';
        if (match && visible < currentVisible) {
          card.style.display = '';
          visible++;
        } else if (match) {
          card.style.display = 'none';
        } else {
          card.style.display = 'none';
        }
      });
      if (visibleCountEl) visibleCountEl.textContent = String(visible);
      if (loadMoreBtn) loadMoreBtn.hidden = visible >= matchedTotal;
    };

    const applySearch = (resetVisible = false) => {
      if (resetVisible) currentVisible = PAGE_SIZE;
      const q = (searchInput?.value || '').toLowerCase().trim();
      matchedTotal = 0;
      cards.forEach((card) => {
        const name = card.dataset.name || '';
        const company = card.dataset.company || '';
        const match = !q || name.includes(q) || company.includes(q);
        card.dataset.match = match ? 'true' : 'false';
        if (match) matchedTotal++;
      });
      updateVisibility();
    };

    loadMoreBtn?.addEventListener('click', () => {
      currentVisible = Math.min(currentVisible + PAGE_SIZE, matchedTotal);
      updateVisibility();
    });

    const sortAttrMap = {
      mmlu: 'mmlu',
      gpqa: 'gpqa',
      hle: 'hle',
      aime: 'aime',
      inputPrice: 'inputPrice',
      outputPrice: 'outputPrice',
      tps: 'tps',
    };

    const sortCards = () => {
      if (!grid) return;
      const metric = sortSelect?.value || 'mmlu';
      const direction = sortDirectionSelect?.value || 'desc';
      const attr = sortAttrMap[metric] ?? 'mmlu';
      cards.sort((a, b) => {
        const valA = Number(a.dataset[attr]) || 0;
        const valB = Number(b.dataset[attr]) || 0;
        if (valA === valB) return 0;
        return direction === 'desc' ? valB - valA : valA - valB;
      });
      cards.forEach((card) => grid.appendChild(card));
      applySearch(true);
    };

    sortSelect?.addEventListener('change', sortCards);
    sortDirectionSelect?.addEventListener('change', sortCards);

    searchInput?.addEventListener('input', () => applySearch(true));

    applySearch(true);
  }
</script>
