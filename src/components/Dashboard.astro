---
import {
  getModels,
  getEpochModels,
  getEpochBenchmarks,
  getEpochBenchmarkRuns,
} from "../lib/supabase";
import Header from "./Header.astro";
import Footer from "./Footer.astro";
import ScrollToTop from "./ScrollToTop.astro";
import { formatScore, formatPrice } from "../lib/format-utils";
import Card from "./ui/Card.astro";
import ModelCard from "./ModelCard.astro";

const models = await getModels();

// Fetch epoch.ai data
const epochModels = await getEpochModels();
const epochBenchmarks = await getEpochBenchmarks();
const epochRuns = await getEpochBenchmarkRuns();

// Key epoch benchmarks to display
const keyEpochBenchmarks = [
  "gpqa_diamond",
  "frontiermath",
  "swe_bench_verified",
  "math_level_5",
  "arc_agi_external",
  "mmlu_external",
  "gsm8k_external",
  "aider_polyglot_external",
];

// Get benchmark name mapping
const epochBenchmarkNames: Record<string, string> = {};
epochBenchmarks.forEach((b) => {
  epochBenchmarkNames[b.slug] = b.name;
});

// Top epoch model by ECI score
const topEciModel = epochModels.find((m) => m.eci_score !== null) ?? null;

const validModels = models.filter((model: any) => {
  const inputPrice = Number(model.price_1m_input_tokens);
  const outputPrice = Number(model.price_1m_output_tokens);
  return inputPrice > 0 && outputPrice > 0;
});

const totalModels = validModels.length;
const INITIAL_VISIBLE_MODELS = Math.min(20, totalModels);
const initialModels = validModels.slice(0, INITIAL_VISIBLE_MODELS);
const avgInputPrice =
  validModels.reduce(
    (sum: number, m: any) => sum + Number(m.price_1m_input_tokens),
    0,
  ) / (totalModels || 1);
const avgOutputPrice =
  validModels.reduce(
    (sum: number, m: any) => sum + Number(m.price_1m_output_tokens),
    0,
  ) / (totalModels || 1);

// Combined benchmark configs - AA benchmarks first, then Epoch benchmarks
const benchmarkConfigs = [
  // AA Benchmarks
  { key: "mmlu_pro", label: "MMLU Pro", source: "aa" },
  { key: "gpqa", label: "GPQA", source: "aa" },
  { key: "hle", label: "HLE", source: "aa" },
  { key: "aime", label: "AIME", source: "aa" },
  { key: "scicode", label: "SciCode", source: "aa" },
  { key: "math_500", label: "Math 500", source: "aa" },
  { key: "livecodebench", label: "LiveCodeBench", source: "aa" },
  { key: "aa_math_index", label: "AA Math Index", source: "aa" },
  { key: "aa_coding_index", label: "AA Coding Index", source: "aa" },
  {
    key: "aa_intelligence_index",
    label: "AA Intelligence Index",
    source: "aa",
  },
  // Epoch Benchmarks
  ...keyEpochBenchmarks.map((slug) => ({
    key: `epoch_${slug}`,
    label: `${epochBenchmarkNames[slug] || slug} (Epoch)`,
    source: "epoch" as const,
  })),
];

// Build top models for AA benchmarks
const topByBenchmark: Record<string, any[]> = {};

// AA benchmarks - from validModels
benchmarkConfigs
  .filter((c) => c.source === "aa")
  .forEach(({ key }) => {
    const list = [...validModels]
      .filter((m: any) => m[key] && Number(m[key]) > 0)
      .sort((a: any, b: any) => Number(b[key]) - Number(a[key]))
      .slice(0, 5);
    topByBenchmark[key] = list;
  });

// Epoch benchmarks - from epochRuns
keyEpochBenchmarks.forEach((slug) => {
  const runs = epochRuns
    .filter((r) => r.benchmark_slug === slug && r.score !== null)
    .sort((a, b) => (b.score ?? 0) - (a.score ?? 0))
    .slice(0, 5)
    .map((r) => ({
      name: r.model_version.replace(/_/g, " ").replace(/-/g, " "),
      company_name: r.organization,
      score: r.score,
      isEpoch: true,
    }));
  topByBenchmark[`epoch_${slug}`] = runs;
});

const topMmluModel =
  [...validModels]
    .filter((m: any) => m.mmlu_pro && Number(m.mmlu_pro) > 0)
    .sort((a: any, b: any) => Number(b.mmlu_pro) - Number(a.mmlu_pro))[0] ??
  null;

const cheapestBlendedModel =
  [...validModels]
    .filter((m: any) => Number(m.price_1m_blended_3_to_1) > 0)
    .sort(
      (a: any, b: any) =>
        Number(a.price_1m_blended_3_to_1) - Number(b.price_1m_blended_3_to_1),
    )[0] ?? null;

// Helper for score coloring
function getScoreClass(score: number | null | undefined): string {
  if (!score || score <= 0) return "score-none";
  const pct = score <= 1 ? score * 100 : score;
  if (pct >= 80) return "score-high";
  if (pct >= 60) return "score-mid";
  if (pct >= 40) return "score-low";
  return "score-poor";
}
---

<div class="min-h-screen bg-base text-text">
  <Header currentPage="dashboard" />

  <main
    class="mx-auto flex max-w-6xl flex-col gap-10 px-4 pb-16 pt-8 md:gap-12 md:pt-10"
  >
    <!-- Hero (simplified, no large card) -->
    <section aria-label="AI Stats overview" class="mt-2 fade-in-section">
      <div
        class="mx-auto flex max-w-4xl flex-col gap-5 md:flex-row md:items-start md:justify-between"
      >
        <div class="text-left">
          <div
            class="inline-flex items-center gap-2 rounded-full border border-highlight-med/60 bg-overlay/70 px-3 py-1 text-[0.65rem] font-medium uppercase tracking-wide text-subtle"
          >
            <span class="h-1.5 w-1.5 rounded-full bg-foam live-pulse"></span>
            <span>Live AI model pricing & benchmarks</span>
          </div>
          <h1
            class="mt-3 bg-gradient-to-r from-foam via-iris to-rose bg-clip-text text-3xl font-extrabold tracking-tight text-transparent sm:text-4xl md:text-5xl shimmer-text"
          >
            AI Stats
          </h1>
          <p class="mt-2 max-w-xl text-sm text-subtle sm:text-base">
            <span id="hero-model-count">{totalModels}</span> LLM models tracked with pricing & performance benchmarks.
            <br />
            Data sourced from ArtificialAnalysis.com & Epoch.ai
          </p>
          <p class="byline mt-3 max-w-xl">
            <span class="byline-text">Built by</span>
            <a
              href="https://jonathanrreed.com"
              target="_blank"
              rel="noopener noreferrer"
              class="byline-name">Jonathan R Reed</a
            >
            <span class="byline-text"
              >to compare model pricing, context limits and performance in one
              place.</span
            >
          </p>

          <!-- Mobile data partners -->
          <div class="mt-3 flex items-center gap-3 md:hidden">
            <img
              src="/icons/Icon + Artificial Analysis - Horizontal SVG.svg"
              alt="Artificial Analysis"
              width="140"
              height="20"
              class="h-5 w-auto opacity-80"
            />
            <span class="text-subtle">+</span>
            <img
              src="/icons/epochaidata.svg"
              alt="Epoch AI"
              width="88"
              height="20"
              class="h-5 w-auto"
            />
          </div>
        </div>

        <!-- Desktop data partners -->
        <div
          class="hidden flex-col items-end gap-3 text-[0.65rem] text-subtle md:flex"
        >
          <span
            class="text-[0.55rem] font-semibold uppercase tracking-wide text-muted"
            >Data Partners</span
          >
          <div class="flex flex-col items-end gap-2">
            <div
              class="inline-flex items-center gap-2 text-xs font-semibold text-text"
              aria-label="Artificial Analysis"
            >
              <img
                src="/icons/Icon + Artificial Analysis - Horizontal SVG.svg"
                alt="Artificial Analysis"
                width="168"
                height="24"
                class="h-6 w-auto opacity-90"
              />
            </div>
            <div
              class="inline-flex items-center gap-2 text-xs font-semibold text-text"
              aria-label="Epoch AI"
            >
              <img
                src="/icons/epochaidata.svg"
                alt="Epoch AI"
                width="106"
                height="24"
                class="h-6 w-auto"
              />
              <span class="text-[0.65rem] text-subtle">Epoch AI</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Top model strip -->
      <div
        class="mx-auto mt-4 grid max-w-4xl gap-3 text-xs sm:text-sm md:grid-cols-2 lg:grid-cols-4 stagger-container"
      >
        <Card class="flex items-center justify-between px-4 py-3 glow-ring stagger-item">
          <div class="text-subtle">Top MMLU model</div>
          <div class="text-right">
            <div class="text-sm font-semibold text-text" id="top-mmlu-name">
              {topMmluModel ? topMmluModel.name : "—"}
            </div>
            <div class="text-[0.7rem] text-subtle" id="top-mmlu-score">
              {topMmluModel ? formatScore(topMmluModel.mmlu_pro) : ""}
            </div>
          </div>
        </Card>
        <Card class="flex items-center justify-between px-4 py-3 glow-ring stagger-item">
          <div class="text-subtle">Cheapest blended price (3:1)</div>
          <div class="text-right">
            <div class="text-sm font-semibold text-text" id="cheapest-blended-name">
              {cheapestBlendedModel ? cheapestBlendedModel.name : "—"}
            </div>
            <div class="text-[0.7rem] text-subtle" id="cheapest-blended-price">
              {
                cheapestBlendedModel
                  ? formatPrice(
                      Number(cheapestBlendedModel.price_1m_blended_3_to_1) || 0,
                      3,
                    )
                  : ""
              }
            </div>
          </div>
        </Card>
        <Card
          class="flex items-center justify-between px-4 py-3 border-iris/30 glow-ring stagger-item"
        >
          <div class="text-subtle">Top ECI Score</div>
          <div class="text-right">
            <div class="text-sm font-semibold text-text" id="top-eci-name">
              {
                topEciModel
                  ? topEciModel.display_name || topEciModel.model_name
                  : "—"
              }
            </div>
            <div class="text-[0.7rem] text-iris" id="top-eci-score">
              {topEciModel ? topEciModel.eci_score?.toFixed(1) : ""} ECI
            </div>
          </div>
        </Card>
        <Card
          class="flex items-center justify-between px-4 py-3 border-iris/30 glow-ring stagger-item"
        >
          <div class="text-subtle">Epoch.ai Models</div>
          <div class="text-right">
            <div class="text-sm font-semibold text-text" id="epoch-models-count">
              {epochModels.length}
            </div>
            <div class="text-[0.7rem] text-iris" id="epoch-runs-count">
              {epochRuns.length} benchmark runs
            </div>
          </div>
        </Card>
      </div>
    </section>

    <!-- Summary stats -->
    <section
      aria-label="Summary stats"
      class="mx-auto grid w-full max-w-4xl gap-4 md:grid-cols-3 fade-in-section stagger-container"
    >
      <Card
        class="bg-gradient-to-b from-surface to-overlay px-4 py-5 text-center shadow-md shadow-black/30 stagger-item"
      >
        <div class="text-[0.7rem] uppercase tracking-wide text-subtle">
          Total models
        </div>
        <div class="mt-2 text-2xl font-semibold text-text" id="summary-total-models">{totalModels}</div>
        <p class="mt-1 text-[0.7rem] text-muted">From ArtificialAnalysis.com</p>
      </Card>
      <Card
        class="bg-gradient-to-b from-surface to-overlay px-4 py-5 text-center shadow-md shadow-black/30 stagger-item"
      >
        <div class="text-[0.7rem] uppercase tracking-wide text-subtle">
          Avg input price
        </div>
        <div class="mt-2 text-2xl font-semibold text-text" id="summary-avg-input">
          {formatPrice(avgInputPrice, 3)}
        </div>
        <p class="mt-1 text-[0.7rem] text-muted">per 1M input tokens</p>
      </Card>
      <Card
        class="bg-gradient-to-b from-surface to-overlay px-4 py-5 text-center shadow-md shadow-black/30 stagger-item"
      >
        <div class="text-[0.7rem] uppercase tracking-wide text-subtle">
          Avg output price
        </div>
        <div class="mt-2 text-2xl font-semibold text-text" id="summary-avg-output">
          {formatPrice(avgOutputPrice, 3)}
        </div>
        <p class="mt-1 text-[0.7rem] text-muted">per 1M output tokens</p>
      </Card>
    </section>

    <!-- Leaderboard -->
    <section aria-label="Leaderboard" class="space-y-4 fade-in-section">
      <Card
        class="overflow-hidden rounded-3xl bg-surface/95 shadow-xl shadow-black/40 gradient-border"
      >
        <header
          class="relative z-20 flex flex-col gap-3 border-b border-highlight-low/80 px-4 py-4 md:flex-row md:items-center md:justify-between md:px-6"
        >
          <div>
            <h2 class="text-base font-semibold text-text md:text-lg">
              Leaderboard
            </h2>
            <p class="text-[0.7rem] text-subtle md:text-xs">
              Switch metrics to see different top-5 rankings.
            </p>
          </div>
          <div class="relative z-30 flex items-center gap-2">
            <label
              for="leaderboard-metric"
              class="text-[0.7rem] font-medium text-subtle"
            >
              Metric
            </label>
            <select
              id="leaderboard-metric"
              class="relative z-30 pointer-events-auto rounded-md border border-highlight-med bg-surface px-2 py-1 text-[0.7rem] text-text shadow-sm focus:outline-none focus:ring-2 focus:ring-foam"
            >
              {
                benchmarkConfigs.map(({ key, label }) => (
                  <option value={key} selected={key === "mmlu_pro"}>
                    {label}
                  </option>
                ))
              }
            </select>
          </div>
        </header>

        <div class="relative z-10 space-y-3 px-4 pb-4 pt-3 md:px-6 md:pb-6" id="leaderboard-panels">
          {
            benchmarkConfigs.map(({ key, source }) => {
              const list = topByBenchmark[key] ?? [];
              if (!list.length) return null;
              const isEpoch = source === "epoch";
              // For epoch benchmarks, score is stored in model.score; for AA, it's model[key]
              const getScore = (m: any) =>
                isEpoch ? Number(m.score) || 0 : Number(m[key]) || 0;
              const maxScore = Math.max(...list.map(getScore));

              return (
                <div
                  data-metric={key}
                  class="overflow-hidden rounded-2xl border border-highlight-low/60"
                  hidden={key !== "mmlu_pro"}
                >
                  <ul class="divide-y divide-highlight-low/40">
                    {list.map((model: any, index: number) => {
                      const score = getScore(model);
                      const barWidth =
                        maxScore > 0 ? (score / maxScore) * 100 : 0;
                      const rankColors = [
                        "from-amber-500/20 to-yellow-500/10 border-l-amber-400",
                        "from-slate-400/15 to-gray-400/5 border-l-slate-300",
                        "from-orange-600/15 to-amber-700/5 border-l-orange-500",
                        "from-transparent to-transparent border-l-highlight-med",
                        "from-transparent to-transparent border-l-highlight-med",
                      ];

                      return (
                        <li class="relative overflow-hidden transition-colors hover:bg-highlight-low/40">
                          {/* Background bar */}
                          <div
                            class={`pointer-events-none absolute inset-y-0 left-0 bg-gradient-to-r ${rankColors[index]} border-l-4`}
                            style={`width: ${barWidth}%`}
                          />

                          <div class="relative grid grid-cols-[2.5rem_1fr_auto] items-center gap-4 px-4 py-3.5">
                            {/* Rank */}
                            <div class="flex items-center justify-center">
                              {index === 0 ? (
                                <div class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-amber-400 to-yellow-500 text-sm font-bold text-amber-900 shadow-lg shadow-amber-500/30">
                                  1
                                </div>
                              ) : index === 1 ? (
                                <div class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-slate-300 to-gray-400 text-sm font-bold text-slate-700 shadow-lg shadow-slate-400/30">
                                  2
                                </div>
                              ) : index === 2 ? (
                                <div class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-orange-400 to-amber-600 text-sm font-bold text-orange-900 shadow-lg shadow-orange-500/30">
                                  3
                                </div>
                              ) : (
                                <div class="flex h-7 w-7 items-center justify-center rounded-full bg-highlight-med/60 text-xs font-semibold text-subtle">
                                  {index + 1}
                                </div>
                              )}
                            </div>

                            {/* Model info */}
                            <div class="min-w-0">
                              <div class="flex items-center gap-2">
                                <span
                                  class={`truncate font-semibold ${index === 0 ? "text-text" : "text-text/90"}`}
                                  title={model.name}
                                >
                                  {model.name}
                                </span>
                              </div>
                              <div class="mt-0.5 text-[0.7rem] text-subtle">
                                {model.company_name ?? "Unknown provider"}
                              </div>
                            </div>

                            {/* Score */}
                            <div
                              class={`text-right font-mono text-lg font-bold ${index === 0 ? "score-high" : index < 3 ? "text-text" : "text-subtle"}`}
                            >
                              {isEpoch
                                ? `${(score * 100).toFixed(1)}%`
                                : formatScore(model[key])}
                            </div>
                          </div>
                        </li>
                      );
                    })}
                  </ul>
                </div>
              );
            })
          }
        </div>
      </Card>
    </section>

    <!-- All models -->
    <section aria-label="All models" class="space-y-4 fade-in-section">
      <header
        class="flex flex-col gap-2 md:flex-row md:items-baseline md:justify-between"
      >
        <div>
          <h2 class="text-lg font-semibold text-text">All models</h2>
          <p class="text-xs text-subtle">
            Search and scan every tracked model.
          </p>
        </div>
        <p class="text-xs text-subtle">
          Showing <span id="visible-model-count">{INITIAL_VISIBLE_MODELS}</span>
          of
          <span id="total-models-count">{totalModels}</span> models
        </p>
      </header>

      <!-- Sticky filter bar -->
      <div
        class="sticky top-0 z-20 -mx-4 bg-base/95 px-4 py-3 backdrop-blur-sm border-b border-highlight-low/50 flex flex-col gap-3 md:flex-row md:items-start md:justify-between"
      >
        <div class="w-full md:max-w-xs">
          <label
            for="model-search"
            class="block text-xs font-medium text-subtle"
          >
            Search models
          </label>
          <input
            id="model-search"
            type="text"
            placeholder="Search by name or company..."
            class="mt-1 w-full rounded-md border border-highlight-med bg-surface px-3 py-2 text-sm text-text shadow-sm placeholder:text-subtle focus:outline-none focus:ring-2 focus:ring-foam"
          />
        </div>

        <div class="flex flex-col gap-2 sm:flex-row sm:items-end">
          <div class="w-full md:max-w-sm">
            <label
              for="model-sort"
              class="block text-xs font-medium text-subtle"
            >
              Sort models
            </label>
            <div class="mt-1 flex flex-col gap-2 sm:flex-row sm:items-center">
              <select
                id="model-sort"
                class="w-full rounded-md border border-highlight-med bg-surface px-3 py-2 text-sm text-text shadow-sm focus:outline-none focus:ring-2 focus:ring-foam"
              >
                <option value="mmlu">MMLU Pro</option>
                <option value="gpqa">GPQA</option>
                <option value="hle">HLE</option>
                <option value="aime">AIME</option>
                <option value="inputPrice">Input price</option>
                <option value="outputPrice">Output price</option>
                <option value="tps">Tokens per second</option>
              </select>
              <label for="model-sort-direction" class="sr-only"
                >Sort direction</label
              >
              <select
                id="model-sort-direction"
                aria-label="Sort direction"
                class="w-full rounded-md border border-highlight-med bg-surface px-3 py-2 text-sm text-text shadow-sm focus:outline-none focus:ring-2 focus:ring-foam sm:w-32"
              >
                <option value="desc">Top first</option>
                <option value="asc">Lowest first</option>
              </select>
            </div>
          </div>

          <!-- View toggle -->
          <div
            class="flex items-center gap-1 rounded-lg border border-highlight-med bg-surface p-1"
          >
            <button
              id="view-cards"
              type="button"
              class="view-toggle-btn active rounded-md px-3 py-1.5 text-xs font-medium transition-colors"
              aria-pressed="true"
              title="Card view"
            >
              <svg
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                ></path>
              </svg>
            </button>
            <button
              id="view-table"
              type="button"
              class="view-toggle-btn rounded-md px-3 py-1.5 text-xs font-medium transition-colors"
              aria-pressed="false"
              title="Table view"
            >
              <svg
                class="h-4 w-4"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Empty state -->
      <div id="empty-state" class="hidden py-16 text-center">
        <svg
          class="mx-auto h-12 w-12 text-muted"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"
          ></path>
        </svg>
        <h3 class="mt-4 text-sm font-semibold text-text">No models found</h3>
        <p class="mt-1 text-xs text-subtle">
          Try adjusting your search or filters.
        </p>
      </div>

      <div class="grid gap-3 md:grid-cols-2 stagger-container" id="models-grid">
        {initialModels.map((model: any) => <ModelCard model={model} />)}
      </div>

      <!-- Table view (hidden by default) -->
      <div id="models-table-container" class="hidden overflow-x-auto">
        <table class="w-full min-w-[800px] text-left text-sm">
          <thead
            class="border-b border-highlight-med bg-overlay/50 text-xs uppercase text-subtle"
          >
            <tr>
              <th class="px-4 py-3 font-semibold">Model</th>
              <th class="px-4 py-3 font-semibold">Provider</th>
              <th class="px-4 py-3 font-semibold text-right">Input</th>
              <th class="px-4 py-3 font-semibold text-right">Output</th>
              <th class="px-4 py-3 font-semibold text-right">MMLU</th>
              <th class="px-4 py-3 font-semibold text-right">GPQA</th>
              <th class="px-4 py-3 font-semibold text-right">TPS</th>
            </tr>
          </thead>
          <tbody
            class="divide-y divide-highlight-low/50"
            id="models-table-body"
          >
            {
              initialModels.map((model: any) => (
                <tr
                  class="cursor-pointer transition-colors hover:bg-highlight-low/50"
                  data-table-row
                  data-model-json={JSON.stringify(model)}
                  data-name={(model.name ?? "").toLowerCase()}
                  data-company={(model.company_name ?? "").toLowerCase()}
                  data-mmlu={Number(model.mmlu_pro) || 0}
                  data-gpqa={Number(model.gpqa) || 0}
                  data-input-price={Number(model.price_1m_input_tokens) || 0}
                  data-output-price={Number(model.price_1m_output_tokens) || 0}
                  data-tps={Number(model.median_output_tokens_per_second) || 0}
                >
                  <td class="px-4 py-3 font-medium text-text">{model.name}</td>
                  <td class="px-4 py-3 text-subtle">
                    {model.company_name ?? "-"}
                  </td>
                  <td class="px-4 py-3 text-right font-mono text-text">
                    {formatPrice(Number(model.price_1m_input_tokens) || 0, 3)}
                  </td>
                  <td class="px-4 py-3 text-right font-mono text-text">
                    {formatPrice(Number(model.price_1m_output_tokens) || 0, 3)}
                  </td>
                  <td
                    class={`px-4 py-3 text-right font-semibold ${getScoreClass(model.mmlu_pro)}`}
                  >
                    {formatScore(model.mmlu_pro)}
                  </td>
                  <td
                    class={`px-4 py-3 text-right font-semibold ${getScoreClass(model.gpqa)}`}
                  >
                    {formatScore(model.gpqa)}
                  </td>
                  <td class="px-4 py-3 text-right text-text">
                    {model.median_output_tokens_per_second
                      ? model.median_output_tokens_per_second.toFixed(1)
                      : "-"}
                  </td>
                </tr>
              ))
            }
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex justify-center">
        <button
          id="load-more-models"
          type="button"
          class="glow-btn rounded-full border border-highlight-med bg-overlay/80 px-5 py-2 text-sm font-semibold text-text shadow-inner shadow-black/30 transition-all duration-300 hover:border-foam hover:text-foam"
        >
          Load more models
        </button>
      </div>
    </section>
  </main>

  <Footer />
  <ScrollToTop />
</div>

<style>
  .model-card {
    transition:
      transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
      border-color 0.25s ease,
      box-shadow 0.25s ease;
  }

  .model-card:hover {
    transform: translateY(-3px);
    border-color: rgba(156, 207, 216, 0.5);
    box-shadow:
      0 12px 28px rgba(0, 0, 0, 0.4),
      0 0 0 1px rgba(156, 207, 216, 0.1),
      0 0 20px rgba(156, 207, 216, 0.08);
  }

  .model-card:active {
    transform: translateY(-1px);
  }

  @media (prefers-reduced-motion: reduce) {
    .model-card {
      transition: none;
    }
    .model-card:hover {
      transform: none;
    }
  }

  /* View toggle buttons */
  .view-toggle-btn {
    color: var(--subtle);
  }
  .view-toggle-btn:hover {
    color: var(--text);
    background: var(--highlight-low);
  }
  .view-toggle-btn.active {
    color: var(--foam);
    background: rgba(156, 207, 216, 0.15);
  }

  /* Byline styles */
  .byline {
    display: inline-flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.3rem;
    padding: 0.5rem 1rem;
    background: rgba(156, 207, 216, 0.06);
    border: 1px solid rgba(156, 207, 216, 0.12);
    border-radius: 9999px;
    font-size: 0.75rem;
    font-style: italic;
  }

  .byline-text {
    color: var(--muted);
  }

  .byline-name {
    font-style: normal;
    font-weight: 600;
    background: linear-gradient(135deg, var(--foam), var(--iris));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    text-decoration: none;
    transition: opacity 0.2s ease;
  }

  .byline-name:hover {
    opacity: 0.8;
  }

  :global(html.light) .byline {
    background: rgba(40, 105, 131, 0.06);
    border: 1px solid rgba(40, 105, 131, 0.12);
  }

  :global(html.light) .byline-name {
    background: linear-gradient(135deg, var(--pine), var(--iris));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
</style>

<script>
  // @ts-nocheck
  if (typeof window !== "undefined") {
    const PAGE_SIZE = 20;
    const AA_BENCHMARKS = [
      { key: "mmlu_pro", label: "MMLU Pro", source: "aa" },
      { key: "gpqa", label: "GPQA", source: "aa" },
      { key: "hle", label: "HLE", source: "aa" },
      { key: "aime", label: "AIME", source: "aa" },
      { key: "scicode", label: "SciCode", source: "aa" },
      { key: "math_500", label: "Math 500", source: "aa" },
      { key: "livecodebench", label: "LiveCodeBench", source: "aa" },
      { key: "aa_math_index", label: "AA Math Index", source: "aa" },
      { key: "aa_coding_index", label: "AA Coding Index", source: "aa" },
      { key: "aa_intelligence_index", label: "AA Intelligence Index", source: "aa" },
    ];

    const grid = document.getElementById("models-grid");
    const tableBody = document.getElementById("models-table-body");
    const tableContainer = document.getElementById("models-table-container");
    const searchInput = document.getElementById("model-search");
    const sortSelect = document.getElementById("model-sort");
    const sortDirectionSelect = document.getElementById("model-sort-direction");
    const loadMoreBtn = document.getElementById("load-more-models");
    const visibleCountEl = document.getElementById("visible-model-count");
    const totalCountEl = document.getElementById("total-models-count");
    const heroCountEl = document.getElementById("hero-model-count");
    const summaryTotalEl = document.getElementById("summary-total-models");
    const summaryAvgInputEl = document.getElementById("summary-avg-input");
    const summaryAvgOutputEl = document.getElementById("summary-avg-output");
    const topMmluNameEl = document.getElementById("top-mmlu-name");
    const topMmluScoreEl = document.getElementById("top-mmlu-score");
    const cheapestNameEl = document.getElementById("cheapest-blended-name");
    const cheapestPriceEl = document.getElementById("cheapest-blended-price");
    const epochModelsCountEl = document.getElementById("epoch-models-count");
    const epochRunsCountEl = document.getElementById("epoch-runs-count");
    const metricSelect = document.getElementById("leaderboard-metric");
    const leaderboardPanels = document.getElementById("leaderboard-panels");
    const emptyState = document.getElementById("empty-state");
    const viewCardsBtn = document.getElementById("view-cards");
    const viewTableBtn = document.getElementById("view-table");

    let currentVisible = PAGE_SIZE;
    let matchedTotal = 0;
    let currentView = "cards";
    let focusedCardIndex = -1;

    const escapeHtml = (value) =>
      String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");

    const toDisplayName = (value, fallback = "—") => {
      const str = String(value ?? "").trim();
      return str || fallback;
    };

    const formatScore = (score) => {
      const num = Number(score);
      if (!Number.isFinite(num) || num <= 0) return "—";
      const pct = num <= 1 ? num * 100 : num;
      return `${pct.toFixed(1)}%`;
    };

    const formatPrice = (price, decimals = 3) => {
      const num = Number(price);
      if (!Number.isFinite(num) || num <= 0) return "—";
      const factor = Math.pow(10, decimals);
      const truncated = Math.trunc(num * factor) / factor;
      return `$${truncated.toFixed(decimals)}`;
    };

    const formatTps = (tps) => {
      const num = Number(tps);
      if (!Number.isFinite(num) || num <= 0) return "—";
      return num.toFixed(1);
    };

    const formatTtft = (ttft) => {
      const num = Number(ttft);
      if (!Number.isFinite(num) || num <= 0) return "—";
      return `${num.toFixed(2)}s`;
    };

    const getScoreClass = (score) => {
      const num = Number(score);
      if (!Number.isFinite(num) || num <= 0) return "score-none";
      const pct = num <= 1 ? num * 100 : num;
      if (pct >= 80) return "score-high";
      if (pct >= 60) return "score-mid";
      if (pct >= 40) return "score-low";
      return "score-poor";
    };

    const sortAttrMap = {
      mmlu: "mmlu",
      gpqa: "gpqa",
      hle: "hle",
      aime: "aime",
      inputPrice: "inputPrice",
      outputPrice: "outputPrice",
      tps: "tps",
    };

    const getCards = () => Array.from(document.querySelectorAll("[data-model-card]"));
    const getTableRows = () => Array.from(document.querySelectorAll("[data-table-row]"));

    const getValidModels = (models) =>
      (models ?? []).filter((model) => {
        const input = Number(model.price_1m_input_tokens);
        const output = Number(model.price_1m_output_tokens);
        return input > 0 && output > 0;
      });

    const getVisibleCards = () => getCards().filter((card) => card.style.display !== "none");

    const updateModelCounts = (models) => {
      const count = models.length;
      if (heroCountEl) heroCountEl.textContent = String(count);
      if (totalCountEl) totalCountEl.textContent = String(count);
      if (summaryTotalEl) summaryTotalEl.textContent = String(count);
    };

    const updateSummaryStats = (models) => {
      const total = models.length || 1;
      const avgInput = models.reduce((sum, m) => sum + (Number(m.price_1m_input_tokens) || 0), 0) / total;
      const avgOutput = models.reduce((sum, m) => sum + (Number(m.price_1m_output_tokens) || 0), 0) / total;
      if (summaryAvgInputEl) summaryAvgInputEl.textContent = formatPrice(avgInput, 3);
      if (summaryAvgOutputEl) summaryAvgOutputEl.textContent = formatPrice(avgOutput, 3);
    };

    const updateTopStrip = (models, epochRuns) => {
      const topMmluModel =
        [...models]
          .filter((m) => Number(m.mmlu_pro) > 0)
          .sort((a, b) => Number(b.mmlu_pro) - Number(a.mmlu_pro))[0] ?? null;

      const cheapestBlended =
        [...models]
          .filter((m) => Number(m.price_1m_blended_3_to_1) > 0)
          .sort(
            (a, b) =>
              Number(a.price_1m_blended_3_to_1) - Number(b.price_1m_blended_3_to_1),
          )[0] ?? null;

      if (topMmluNameEl) topMmluNameEl.textContent = topMmluModel ? toDisplayName(topMmluModel.name) : "—";
      if (topMmluScoreEl) topMmluScoreEl.textContent = topMmluModel ? formatScore(topMmluModel.mmlu_pro) : "";
      if (cheapestNameEl) cheapestNameEl.textContent = cheapestBlended ? toDisplayName(cheapestBlended.name) : "—";
      if (cheapestPriceEl) {
        cheapestPriceEl.textContent = cheapestBlended
          ? formatPrice(cheapestBlended.price_1m_blended_3_to_1, 3)
          : "";
      }

      if (Array.isArray(epochRuns) && epochRunsCountEl) {
        epochRunsCountEl.textContent = `${epochRuns.length} benchmark runs`;
      }
      if (Array.isArray(epochRuns) && epochModelsCountEl) {
        const modelCount = new Set(
          epochRuns.map((run) => String(run.model_version || "").trim()).filter(Boolean),
        ).size;
        epochModelsCountEl.textContent = String(modelCount);
      }
    };

    const buildTopByBenchmark = (models, epochBenchmarks, epochRuns) => {
      const topByBenchmark = {};
      const aaConfigs = [];
      const epochConfigs = [];

      AA_BENCHMARKS.forEach((config) => {
        const list = [...models]
          .filter((model) => Number(model[config.key]) > 0)
          .sort((a, b) => Number(b[config.key]) - Number(a[config.key]))
          .slice(0, 5);
        if (!list.length) return;
        topByBenchmark[config.key] = list;
        aaConfigs.push(config);
      });

      epochBenchmarks.forEach((benchmark) => {
        const key = `epoch_${benchmark.slug}`;
        const list = epochRuns
          .filter((run) => run.benchmark_slug === benchmark.slug && run.score !== null)
          .sort((a, b) => Number(b.score) - Number(a.score))
          .slice(0, 5)
          .map((run) => ({
            name: String(run.model_version || "").replace(/_/g, " ").replace(/-/g, " "),
            company_name: run.organization ?? "Unknown provider",
            score: Number(run.score) || 0,
          }));
        if (!list.length) return;
        topByBenchmark[key] = list;
        epochConfigs.push({
          key,
          label: `${benchmark.name} (Epoch)`,
          source: "epoch",
        });
      });

      return { benchmarkConfigs: [...aaConfigs, ...epochConfigs], topByBenchmark };
    };

    const renderLeaderboard = (models, epochBenchmarks, epochRuns) => {
      if (!metricSelect || !leaderboardPanels) return;

      const selectedMetric = metricSelect.value || "mmlu_pro";
      const { benchmarkConfigs, topByBenchmark } = buildTopByBenchmark(
        models,
        epochBenchmarks ?? [],
        epochRuns ?? [],
      );

      metricSelect.innerHTML = benchmarkConfigs
        .map(
          (config) =>
            `<option value="${escapeHtml(config.key)}">${escapeHtml(config.label)}</option>`,
        )
        .join("");

      const fallbackMetric = benchmarkConfigs[0]?.key ?? "mmlu_pro";
      metricSelect.value = benchmarkConfigs.some((config) => config.key === selectedMetric)
        ? selectedMetric
        : fallbackMetric;

      leaderboardPanels.innerHTML = benchmarkConfigs
        .map((config) => {
          const list = topByBenchmark[config.key] ?? [];
          if (!list.length) return "";

          const isEpoch = config.source === "epoch";
          const getScore = (model) => (isEpoch ? Number(model.score) || 0 : Number(model[config.key]) || 0);
          const formatBenchmarkScore = (score) => {
            if (!Number.isFinite(score) || score <= 0) return "—";
            if (!isEpoch) return formatScore(score);
            const pct = score <= 1 ? score * 100 : score;
            return `${pct.toFixed(1)}%`;
          };
          const maxScore = Math.max(...list.map(getScore), 0);
          const rankColors = [
            "from-amber-500/20 to-yellow-500/10 border-l-amber-400",
            "from-slate-400/15 to-gray-400/5 border-l-slate-300",
            "from-orange-600/15 to-amber-700/5 border-l-orange-500",
            "from-transparent to-transparent border-l-highlight-med",
            "from-transparent to-transparent border-l-highlight-med",
          ];

          const rows = list
            .map((model, index) => {
              const score = getScore(model);
              const barWidth = maxScore > 0 ? (score / maxScore) * 100 : 0;
              const scoreText = formatBenchmarkScore(score);
              const name = escapeHtml(toDisplayName(model.name));
              const company = escapeHtml(toDisplayName(model.company_name, "Unknown provider"));
              const rankBadge =
                index === 0
                  ? '<div class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-amber-400 to-yellow-500 text-sm font-bold text-amber-900 shadow-lg shadow-amber-500/30">1</div>'
                  : index === 1
                    ? '<div class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-slate-300 to-gray-400 text-sm font-bold text-slate-700 shadow-lg shadow-slate-400/30">2</div>'
                    : index === 2
                      ? '<div class="flex h-8 w-8 items-center justify-center rounded-full bg-gradient-to-br from-orange-400 to-amber-600 text-sm font-bold text-orange-900 shadow-lg shadow-orange-500/30">3</div>'
                      : `<div class="flex h-7 w-7 items-center justify-center rounded-full bg-highlight-med/60 text-xs font-semibold text-subtle">${index + 1}</div>`;

              return `
                <li class="relative overflow-hidden transition-colors hover:bg-highlight-low/40">
                  <div class="pointer-events-none absolute inset-y-0 left-0 bg-gradient-to-r ${rankColors[index]} border-l-4" style="width: ${barWidth}%"></div>
                  <div class="relative grid grid-cols-[2.5rem_1fr_auto] items-center gap-4 px-4 py-3.5">
                    <div class="flex items-center justify-center">${rankBadge}</div>
                    <div class="min-w-0">
                      <div class="flex items-center gap-2">
                        <span class="truncate font-semibold ${index === 0 ? "text-text" : "text-text/90"}" title="${name}">${name}</span>
                      </div>
                      <div class="mt-0.5 text-[0.7rem] text-subtle">${company}</div>
                    </div>
                    <div class="text-right font-mono text-lg font-bold ${index === 0 ? "score-high" : index < 3 ? "text-text" : "text-subtle"}">${scoreText}</div>
                  </div>
                </li>
              `;
            })
            .join("");

          const hiddenAttr = config.key === metricSelect.value ? "" : " hidden";
          return `
            <div data-metric="${escapeHtml(config.key)}" class="overflow-hidden rounded-2xl border border-highlight-low/60"${hiddenAttr}>
              <ul class="divide-y divide-highlight-low/40">${rows}</ul>
            </div>
          `;
        })
        .join("");

      // Keep metric select and panel set in lockstep.
      const panelKeys = new Set(
        Array.from(document.querySelectorAll("[data-metric]"))
          .map((el) => el.getAttribute("data-metric"))
          .filter(Boolean),
      );
      Array.from(metricSelect.options).forEach((option) => {
        if (!panelKeys.has(option.value)) option.remove();
      });
      if (!panelKeys.has(metricSelect.value)) {
        metricSelect.value = metricSelect.options[0]?.value ?? "mmlu_pro";
      }

      Array.from(document.querySelectorAll("[data-metric]")).forEach((el) => {
        if (!(el instanceof HTMLElement)) return;
        const shouldHide = el.dataset.metric !== metricSelect.value;
        el.hidden = shouldHide;
        el.classList.toggle("hidden", shouldHide);
      });
    };

    const createCardMarkup = (model) => {
      const name = escapeHtml(toDisplayName(model.name));
      const company = escapeHtml(toDisplayName(model.company_name, "Unknown provider"));
      return `
        <div
          data-model-card
          data-model-id="${escapeHtml(model.id)}"
          data-model-json="${escapeHtml(JSON.stringify(model))}"
          data-name="${escapeHtml(String(model.name ?? "").toLowerCase())}"
          data-company="${escapeHtml(String(model.company_name ?? "").toLowerCase())}"
          data-mmlu="${Number(model.mmlu_pro) || 0}"
          data-gpqa="${Number(model.gpqa) || 0}"
          data-hle="${Number(model.hle) || 0}"
          data-aime="${Number(model.aime) || 0}"
          data-input-price="${Number(model.price_1m_input_tokens) || 0}"
          data-output-price="${Number(model.price_1m_output_tokens) || 0}"
          data-tps="${Number(model.median_output_tokens_per_second) || 0}"
          class="model-card group rounded-2xl border border-highlight-med bg-surface/95 px-4 py-4 text-sm shadow-md shadow-black/30 gradient-border stagger-item tilt-card"
        >
          <header class="flex items-start justify-between gap-2">
            <div class="min-w-0">
              <h3 class="truncate text-sm font-semibold text-text group-hover:text-foam transition-colors" title="${name}">${name}</h3>
              <p class="mt-0.5 text-xs text-subtle">${company}</p>
            </div>
            <div class="text-right text-[0.65rem] text-subtle flex-shrink-0">
              <div>Input: ${formatPrice(model.price_1m_input_tokens, 3)}</div>
              <div>Output: ${formatPrice(model.price_1m_output_tokens, 3)}</div>
            </div>
          </header>
          <div class="mt-3 grid gap-2 text-[0.7rem] text-subtle grid-cols-2">
            <section class="rounded-lg border border-highlight-low/60 bg-overlay/50 px-3 py-2">
              <div class="text-[0.55rem] uppercase tracking-wide text-muted">Benchmarks</div>
              <dl class="mt-1.5 space-y-0.5 text-text text-[0.65rem]">
                <div class="flex items-center justify-between"><dt>MMLU</dt><dd class="font-semibold ${getScoreClass(model.mmlu_pro)}">${formatScore(model.mmlu_pro)}</dd></div>
                <div class="flex items-center justify-between"><dt>GPQA</dt><dd class="font-semibold ${getScoreClass(model.gpqa)}">${formatScore(model.gpqa)}</dd></div>
                <div class="flex items-center justify-between"><dt>HLE</dt><dd class="font-semibold ${getScoreClass(model.hle)}">${formatScore(model.hle)}</dd></div>
              </dl>
            </section>
            <section class="rounded-lg border border-highlight-low/60 bg-overlay/50 px-3 py-2">
              <div class="text-[0.55rem] uppercase tracking-wide text-muted">Performance</div>
              <dl class="mt-1.5 space-y-0.5 text-text text-[0.65rem]">
                <div class="flex items-center justify-between"><dt>TPS</dt><dd class="font-semibold">${formatTps(model.median_output_tokens_per_second)}</dd></div>
                <div class="flex items-center justify-between"><dt>TTFT</dt><dd class="font-semibold">${formatTtft(model.median_time_to_first_answer_token)}</dd></div>
                <div class="flex items-center justify-between"><dt>Blended</dt><dd class="font-semibold">${formatPrice(model.price_1m_blended_3_to_1, 3)}</dd></div>
              </dl>
            </section>
          </div>
        </div>
      `;
    };

    const createTableRowMarkup = (model) => `
      <tr
        class="cursor-pointer transition-colors hover:bg-highlight-low/50"
        data-table-row
        data-model-json="${escapeHtml(JSON.stringify(model))}"
        data-name="${escapeHtml(String(model.name ?? "").toLowerCase())}"
        data-company="${escapeHtml(String(model.company_name ?? "").toLowerCase())}"
        data-mmlu="${Number(model.mmlu_pro) || 0}"
        data-gpqa="${Number(model.gpqa) || 0}"
        data-input-price="${Number(model.price_1m_input_tokens) || 0}"
        data-output-price="${Number(model.price_1m_output_tokens) || 0}"
        data-tps="${Number(model.median_output_tokens_per_second) || 0}"
      >
        <td class="px-4 py-3 font-medium text-text">${escapeHtml(toDisplayName(model.name))}</td>
        <td class="px-4 py-3 text-subtle">${escapeHtml(toDisplayName(model.company_name, "-"))}</td>
        <td class="px-4 py-3 text-right font-mono text-text">${formatPrice(model.price_1m_input_tokens, 3)}</td>
        <td class="px-4 py-3 text-right font-mono text-text">${formatPrice(model.price_1m_output_tokens, 3)}</td>
        <td class="px-4 py-3 text-right font-semibold ${getScoreClass(model.mmlu_pro)}">${formatScore(model.mmlu_pro)}</td>
        <td class="px-4 py-3 text-right font-semibold ${getScoreClass(model.gpqa)}">${formatScore(model.gpqa)}</td>
        <td class="px-4 py-3 text-right text-text">${formatTps(model.median_output_tokens_per_second)}</td>
      </tr>
    `;

    const bindCardFocus = () => {
      getCards().forEach((card) => {
        card.setAttribute("tabindex", "0");
        card.addEventListener("focus", () => {
          focusedCardIndex = getVisibleCards().indexOf(card);
        });
      });
    };

    const bindTableRows = () => {
      getTableRows().forEach((row) => {
        row.addEventListener("click", () => {
          const modelJson = row.dataset.modelJson;
          if (!modelJson) return;
          try {
            const model = JSON.parse(modelJson);
            window.dispatchEvent(new CustomEvent("open-model-drawer", { detail: model }));
          } catch (error) {
            console.warn("Failed to parse row model payload", error);
          }
        });
      });
    };

    const updateVisibility = () => {
      let visible = 0;
      getCards().forEach((card) => {
        const match = card.dataset.match === "true";
        if (match && visible < currentVisible) {
          card.style.display = "";
          visible += 1;
        } else {
          card.style.display = "none";
        }
      });

      if (visibleCountEl) visibleCountEl.textContent = String(visible);
      if (loadMoreBtn) loadMoreBtn.hidden = visible >= matchedTotal;
      if (grid && currentView === "cards") grid.style.display = matchedTotal === 0 ? "none" : "";
      if (emptyState) emptyState.classList.toggle("hidden", matchedTotal > 0);
    };

    const applyTableSearch = () => {
      const q = (searchInput?.value || "").toLowerCase().trim();
      getTableRows().forEach((row) => {
        const name = row.dataset.name || "";
        const company = row.dataset.company || "";
        row.style.display = !q || name.includes(q) || company.includes(q) ? "" : "none";
      });
    };

    const applySearch = (resetVisible = false) => {
      if (resetVisible) currentVisible = PAGE_SIZE;
      const q = (searchInput?.value || "").toLowerCase().trim();
      matchedTotal = 0;

      getCards().forEach((card) => {
        const name = card.dataset.name || "";
        const company = card.dataset.company || "";
        const match = !q || name.includes(q) || company.includes(q);
        card.dataset.match = match ? "true" : "false";
        if (match) matchedTotal += 1;
      });

      updateVisibility();
      if (currentView === "table") applyTableSearch();
    };

    const sortCards = () => {
      if (!grid) return;
      const metric = sortSelect?.value || "mmlu";
      const direction = sortDirectionSelect?.value || "desc";
      const attr = sortAttrMap[metric] ?? "mmlu";

      const cards = getCards();
      cards.sort((a, b) => {
        const valA = Number(a.dataset[attr]) || 0;
        const valB = Number(b.dataset[attr]) || 0;
        if (valA === valB) return 0;
        return direction === "desc" ? valB - valA : valA - valB;
      });
      cards.forEach((card) => grid.appendChild(card));

      const rows = getTableRows();
      rows.sort((a, b) => {
        const valA = Number(a.dataset[attr]) || 0;
        const valB = Number(b.dataset[attr]) || 0;
        if (valA === valB) return 0;
        return direction === "desc" ? valB - valA : valA - valB;
      });
      rows.forEach((row) => tableBody?.appendChild(row));

      applySearch(true);
    };

    const setView = (view) => {
      currentView = view;
      if (view === "cards") {
        if (grid) grid.style.display = matchedTotal === 0 ? "none" : "";
        tableContainer?.classList.add("hidden");
        viewCardsBtn?.classList.add("active");
        viewCardsBtn?.setAttribute("aria-pressed", "true");
        viewTableBtn?.classList.remove("active");
        viewTableBtn?.setAttribute("aria-pressed", "false");
        if (loadMoreBtn) loadMoreBtn.style.display = "";
      } else {
        if (grid) grid.style.display = "none";
        tableContainer?.classList.remove("hidden");
        viewCardsBtn?.classList.remove("active");
        viewCardsBtn?.setAttribute("aria-pressed", "false");
        viewTableBtn?.classList.add("active");
        viewTableBtn?.setAttribute("aria-pressed", "true");
        if (loadMoreBtn) loadMoreBtn.style.display = "none";
        applyTableSearch();
      }
    };

    const renderModels = (models) => {
      if (!grid || !tableBody) return;
      grid.innerHTML = models.map(createCardMarkup).join("");
      tableBody.innerHTML = models.map(createTableRowMarkup).join("");
      bindCardFocus();
      bindTableRows();
      sortCards();
      setView(currentView);
    };

    metricSelect?.addEventListener("change", () => {
      const metric = metricSelect.value;
      Array.from(document.querySelectorAll("[data-metric]")).forEach((el) => {
        if (!(el instanceof HTMLElement)) return;
        const shouldHide = el.dataset.metric !== metric;
        el.hidden = shouldHide;
        el.classList.toggle("hidden", shouldHide);
      });
    });

    loadMoreBtn?.addEventListener("click", () => {
      currentVisible = Math.min(currentVisible + PAGE_SIZE, matchedTotal);
      updateVisibility();
    });

    sortSelect?.addEventListener("change", sortCards);
    sortDirectionSelect?.addEventListener("change", sortCards);
    searchInput?.addEventListener("input", () => applySearch(true));
    viewCardsBtn?.addEventListener("click", () => setView("cards"));
    viewTableBtn?.addEventListener("click", () => setView("table"));

    document.addEventListener("keydown", (event) => {
      const visibleCards = getVisibleCards();
      if (!visibleCards.length) return;
      if (event.key !== "ArrowDown" && event.key !== "ArrowUp") return;
      event.preventDefault();
      const delta = event.key === "ArrowDown" ? 1 : -1;
      focusedCardIndex = Math.max(
        0,
        Math.min(visibleCards.length - 1, focusedCardIndex + delta),
      );
      visibleCards[focusedCardIndex]?.focus();
    });

    bindCardFocus();
    bindTableRows();
    applySearch(true);

    window.addEventListener("aistats:live-snapshot", (event) => {
      const snapshot = event.detail;
      if (!snapshot) return;

      const liveModels = getValidModels(snapshot.aaModels ?? []);
      const epochBenchmarks = snapshot.epochBenchmarks ?? [];
      const epochRuns = snapshot.epochRuns ?? [];

      updateModelCounts(liveModels);
      updateSummaryStats(liveModels);
      updateTopStrip(liveModels, epochRuns);
      renderLeaderboard(liveModels, epochBenchmarks, epochRuns);
      renderModels(liveModels);
    });
  }
</script>

<script>
  import { fetchLiveSnapshot } from "../lib/live-data";

  const scheduleLiveRefresh = () => {
    const run = async () => {
      const snapshot = await fetchLiveSnapshot({ includeEpoch: false });
      if (!snapshot) return;
      window.dispatchEvent(
        new CustomEvent("aistats:live-snapshot", { detail: snapshot }),
      );
    };

    if ("requestIdleCallback" in window) {
      window.requestIdleCallback(() => {
        void run();
      }, { timeout: 5000 });
    } else {
      setTimeout(() => {
        void run();
      }, 2500);
    }
  };

  if (document.readyState === "complete") {
    scheduleLiveRefresh();
  } else {
    window.addEventListener("load", scheduleLiveRefresh, { once: true });
  }
</script>
